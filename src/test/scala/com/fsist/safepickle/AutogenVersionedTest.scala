package com.fsist.safepickle

import com.fsist.safepickle.Schema.{SInt, SObject, SObjectMember}
import org.scalatest.FunSuite

object AutogenVersionedTest {
  object Scope1 {
    case class Old(s: String) extends OldVersion[New] {
      override def toNewVersion: New = New(s.toInt)
    }

    case class New(i: Int)
    object New {
      implicit val pickler : Pickler[New] = Autogen.versioned[New, Old]
    }
  }

  object Scope2 {
    case class V1(s: String) extends OldVersion[V2] {
      override def toNewVersion: V2 = V2(true)
    }

    case class V2(b: Boolean) extends OldVersion[V3] {
      override def toNewVersion: V3 = V3(123L)
    }

    case class V3(l: Long) extends OldVersion[New] {
      override def toNewVersion: New = New(l.toInt)
    }

    case class New(i: Int)
    object New {
      implicit val pickler : Pickler[New] = Autogen.versioned[New, V1]
    }
  }
}

class AutogenVersionedTest extends FunSuite with WrapperTester {
  import AutogenVersionedTest._

  def testReading[T](pickled: Wrapper, expected: T)(implicit pickler: Pickler[T]) =  {
    val reader = WrapperBackend.reader(pickled)
    val value = reader.read[T]()
    assert(value == expected)
  }

  test("Versioned") {
    import Scope1._

    roundtrip(
      New(123),
      ObjectWrapper(Map(
        "$version" -> IntWrapper(2),
        "i" -> IntWrapper(123)
      ))
    )

    testReading[New](
      ObjectWrapper(Map(
        "$version" -> IntWrapper(1),
        "s" -> StringWrapper("4")
      )),
      New(4)
    )
  }

  test("Versioned schema") {
    import Scope1._
    import scala.reflect.runtime.universe.typeOf

    def versionMember(schema: Schema): SObjectMember =
      schema.asInstanceOf[SObject].members.find(_.name == "$version").get

    assert(versionMember(New.pickler.schema) ==
      SObjectMember("$version", SInt(typeOf[Int]), true, Nil, Some(2))
    )
  }

  test("Multiple versions") {
    import Scope2._

    roundtrip(
      New(123),
      ObjectWrapper(Map(
        "$version" -> IntWrapper(4),
        "i" -> IntWrapper(123)
      ))
    )

    testReading[New](
      ObjectWrapper(Map(
        "$version" -> IntWrapper(1),
        "s" -> StringWrapper("4")
      )),
      New(123)
    )

    testReading[New](
      ObjectWrapper(Map(
        "$version" -> IntWrapper(2),
        "b" -> BooleanWrapper(false)
      )),
      New(123)
    )

    testReading[New](
      ObjectWrapper(Map(
        "$version" -> IntWrapper(3),
        "l" -> LongWrapper(123L)
      )),
      New(123)
    )
  }

  test("Become versioned") {
    import Scope1._
    testReading[New](
      ObjectWrapper(Map(
        "s" -> StringWrapper("4")
      )),
      New(4)
    )
  }
}
